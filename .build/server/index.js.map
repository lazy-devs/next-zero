{"version":3,"sources":["../../src/server/index.js"],"names":["nextServer","app","router","name","process","env","PORT","port","use","enableTypes","formLimit","jsonLimit","ctx","next","res","statusCode","status","body","message","get","getRequestHandler","req","respond","handleListen","console","log","chalk"],"mappings":";AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA,2D;;AAEe,wBAAsD,KAAnDA,UAAmD,QAAnDA,UAAmD,CAAvCC,GAAuC,QAAvCA,GAAuC,CAAlCC,MAAkC,QAAlCA,MAAkC,kBAA1BC,IAA0B,CAA1BA,IAA0B,0BAAnB,KAAmB;AAC3CC,EAAAA,OAAO,CAACC,GADmC,CAC3DC,IAD2D,CAC3DA,IAD2D,kCACpD,IADoD;AAEnE,MAAMC,IAAI,GAAG,wBAASD,IAAT,EAAe,EAAf,CAAb;;AAEA;;AAEAL,EAAAA,GAAG,CAACO,GAAJ;AACE,8BAAW;AACTC,IAAAA,WAAW,EAAE,CAAC,MAAD,EAAS,MAAT,CADJ;AAETC,IAAAA,SAAS,EAAE,MAFF;AAGTC,IAAAA,SAAS,EAAE,MAHF,EAAX,CADF;;;;AAQAV,EAAAA,GAAG,CAACO,GAAJ,CAAQ,4BAAR;;AAEAP,EAAAA,GAAG,CAACO,GAAJ,gHAAQ,iBAAOI,GAAP,EAAqBC,IAArB;;AAEJD,cAAAA,GAAG,CAACE,GAAJ,CAAQC,UAAR,GAAqB,GAArB,CAFI;AAGEF,gBAAAA,IAAI,EAHN;;AAKJD,cAAAA,GAAG,CAACI,MAAJ,GAAa,YAAID,UAAJ,IAAkB,YAAIC,MAAtB,IAAgC,GAA7C;AACAJ,cAAAA,GAAG,CAACK,IAAJ,GAAW;AACTC,gBAAAA,OAAO,EAAE,YAAIA,OADJ,EAAX,CANI,yEAAR;;;;;AAYAhB,EAAAA,MAAM,CAACiB,GAAP,CAAW,GAAX,gHAAgB,kBAAOP,GAAP;AACTA,cAAAA,GAAG,CAACK,IADK;AAENjB,gBAAAA,UAAU,CAACoB,iBAAX,GAA+BR,GAAG,CAACS,GAAnC,EAAwCT,GAAG,CAACE,GAA5C,CAFM;AAGZF,cAAAA,GAAG,CAACU,OAAJ,GAAc,KAAd,CAHY,0DAAhB;;;;AAOA,SAAO;AACLrB,IAAAA,GAAG,EAAHA,GADK;AAELD,IAAAA,UAAU,EAAVA,UAFK;AAGLuB,IAAAA,YAAY,EAAE,wBAAM;AAClB;AACAC,MAAAA,OAAO,CAACC,GAAR,KAAYC,cAAZ,qBAA0BvB,IAA1B;AACAqB,MAAAA,OAAO,CAACC,GAAR,KAAYC,cAAZ,sBAA0BvB,IAA1B,EAA8CF,GAAG,CAACI,GAAlD;AACAmB,MAAAA,OAAO,CAACC,GAAR,uCAA2ClB,IAA3C;AACD,KARI,EAAP;;AAUD,C","sourcesContent":["// @flow\nimport chalk from 'chalk';\nimport bodyParser from 'koa-bodyparser';\nimport reqId from '@kasa/koa-request-id';\nimport Koa, { type Context } from 'koa';\nimport Router from 'koa-router';\nimport { type Server } from 'next';\n\nexport { default as apmMiddleware } from './apm-middleware';\nexport { default as withNZ } from './with-nz';\n\nexport default ({ nextServer, app, router, name = 'App' }: Props) => {\n  const { PORT = 4000 } = process.env;\n  const port = parseInt(PORT, 10);\n\n  // Handle uncaught errors\n\n  app.use(\n    bodyParser({\n      enableTypes: ['json', 'form'],\n      formLimit: '10mb',\n      jsonLimit: '10mb',\n    })\n  );\n\n  app.use(reqId());\n\n  app.use(async (ctx: Context, next: VoidFunction) => {\n    try {\n      ctx.res.statusCode = 200;\n      await next();\n    } catch (err) {\n      ctx.status = err.statusCode || err.status || 500;\n      ctx.body = {\n        message: err.message,\n      };\n    }\n  });\n\n  router.get('*', async (ctx: Context) => {\n    if (!ctx.body) {\n      await nextServer.getRequestHandler()(ctx.req, ctx.res);\n      ctx.respond = false;\n    }\n  });\n\n  return {\n    app,\n    nextServer,\n    handleListen: () => {\n      /* eslint-disable no-console */\n      console.log(chalk`{blue ${name}} Start WEB server.`);\n      console.log(chalk`{blue ${name}} ENV {green ${app.env}}`);\n      console.log(`> Ready on http://localhost:${port}`);\n    },\n  };\n};\n\ntype Props = {\n  app: Koa<object>,\n  router: Router<object>,\n  nextServer: Server,\n  name: string,\n};\n"],"file":"index.js"}