{"version":3,"sources":["../../src/server/apm-middleware.js"],"names":["ctx","next","apm","isStarted","res","on","captureError","reqId","state","req","id","get","custom","setCustomContext","setUserContext","userId"],"mappings":"sYAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEe,oBAAM;AACnB,uHAAO,iBAAOA,GAAP,EAAYC,IAAZ;;AAEAC,wCAAIC,SAAJ,EAFA;;AAIGF,kBAAAA,IAAI,EAJP;;;;;AASGA,kBAAAA,IAAI,EATP;;AAWH;AACAD,gBAAAA,GAAG,CAACI,GAAJ,CAAQC,EAAR,CAAW,QAAX,EAAqB,YAAM;AACzBH,0CAAII,YAAJ;;AAEA;AACD,iBAJD,EAZG;;;AAmBH;AACMC,gBAAAA,KApBH,GAoBWP,GAAG,CAACQ,KAAJ,CAAUD,KAAV,IAAmBP,GAAG,CAACO,KAAvB,IAAgCP,GAAG,CAACS,GAAJ,CAAQC,EAAxC,IAA8CV,GAAG,CAACW,GAAJ,CAAQ,cAAR,CApBzD;AAqBGC,gBAAAA,MArBH,GAqBY,EAAEL,KAAK,EAALA,KAAF,EArBZ;AAsBHL,wCAAIW,gBAAJ,CAAqBD,MAArB;;AAEA;AACAV,wCAAIY,cAAJ,CAAmB,EAAEC,MAAM,EAAE,MAAV,EAAnB,EAzBG,CAyBqC;AAzBrC,4HAAP;;AA4BD,C","sourcesContent":["import apm from 'elastic-apm-node';\n\n// function redactAuthHeaders(payload) {\n//   if (payload.context && payload.context.request && payload.context.request.headers) {\n//     const headers = payload.context.request.headers;\n//     if (headers['x-authenticated-userid']) {\n//       headers['x-authenticated-userid'] = '[REDACTED]';\n//     }\n//   }\n//   return payload;\n// }\n\n// apm.addFilter(redactAuthHeaders);\n\nexport default () => {\n  return async (ctx, next) => {\n    // Skip if apm is disabled\n    if (!apm.isStarted()) {\n      // Skipped because APM is disabled\n      await next();\n      return;\n    }\n\n    try {\n      await next();\n    } catch (err) {\n      // Sending error when response is sent\n      ctx.res.on('finish', () => {\n        apm.captureError(err);\n\n        // Sent error to APM server\n      });\n      throw err;\n    } finally {\n      // Set custom context data\n      const reqId = ctx.state.reqId || ctx.reqId || ctx.req.id || ctx.get('X-Request-Id');\n      const custom = { reqId };\n      apm.setCustomContext(custom);\n\n      // Set user context data\n      apm.setUserContext({ userId: 'test' }); // ctx.state.user\n    }\n  };\n};\n"],"file":"apm-middleware.js"}